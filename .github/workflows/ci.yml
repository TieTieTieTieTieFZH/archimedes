name: ğŸš€ ç®€åŒ–CIæµæ°´çº¿

# è§¦å‘æ¡ä»¶ - ä»…ä¸»è¦åˆ†æ”¯
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # ğŸ§ª åŸºæœ¬æµ‹è¯•
  test:
    name: ğŸ§ª ç¼–è¯‘å’Œæµ‹è¯•
    runs-on: ubuntu-latest
    
    services:
      # MySQL æœåŠ¡
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: 1234
          MYSQL_DATABASE: archimedes_test
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
      
      # Elasticsearch æœåŠ¡
      elasticsearch:
        image: docker.elastic.co/elasticsearch/elasticsearch:8.11.1
        env:
          discovery.type: single-node
          xpack.security.enabled: false
          ES_JAVA_OPTS: -Xms512m -Xmx512m
        ports:
          - 9200:9200
        options: --health-cmd="curl -f http://localhost:9200/_cluster/health" --health-interval=30s --health-timeout=10s --health-retries=5
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: â˜• è®¾ç½® JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'maven'
        
    - name: ğŸ“Š ç­‰å¾…æœåŠ¡å¯åŠ¨
      run: |
        echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
        timeout 60 bash -c 'until curl -f http://localhost:9200/_cluster/health; do sleep 2; done'
        timeout 60 bash -c 'until mysqladmin ping -h 127.0.0.1 --silent; do sleep 2; done'
        echo "âœ… æœåŠ¡å·²å°±ç»ª"
    
    - name: ğŸ”§ ç¼–è¯‘é¡¹ç›®
      run: ./mvnw clean compile -DskipTests
      
    - name: ğŸ§ª è¿è¡Œæµ‹è¯•
      run: ./mvnw test
      
    - name: ğŸ“Š ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
      uses: dorny/test-reporter@v1
      if: success() || failure()
      with:
        name: ğŸ“ˆ æµ‹è¯•ç»“æœ
        path: target/surefire-reports/*.xml
        reporter: java-junit

  # ğŸ“¦ æ„å»ºäº§ç‰© (ä»…ä¸»åˆ†æ”¯)
  build:
    name: ğŸ“¦ æ„å»ºJAR
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: â˜• è®¾ç½® JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'maven'
        
    - name: ğŸ“¦ æ„å»ºJARæ–‡ä»¶
      run: ./mvnw clean package -DskipTests
      
    - name: ğŸ“¤ ä¸Šä¼ äº§ç‰©
      uses: actions/upload-artifact@v3
      with:
        name: archimedes-${{ github.sha }}
        path: target/*.jar
        retention-days: 7